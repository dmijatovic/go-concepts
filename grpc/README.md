# gRPC protocol

This folder demos gRPC implementations in Go. It is based on Udemy training.

Official [gRPC documentation is here](https://grpc.io/).
Protocol buffers [github repo is here](https://github.com/protocolbuffers/protobuf).

## Requirements

- Golang
- IDE (VSC adviced): install proto3 plugin for VSC
- Protoc: protocol buffer compiler. For installation [see here](https://grpc.io/docs/protoc-installation/)

```bash
# check if you have protobuf
protoc --version
# ensure version 3+

# install
sudo apt-get install protobuf-compiler

```

## Dependencies

To use gRPC in go application go-grpc module is required.

```bash
# install go-grpc
go -u get google.golang.org/grpc
# protocol buffers support
go -u get github.com/golang/protobuf/protoc-gen-go

```

## PATH definitions

First compilation did not worked. Based on [this issue I extended GOPATH info](https://github.com/golang/protobuf/issues/795) in my .profile file.

```bash
# ADD GOPATH INFO
export GOROOT=/usr/local/go/bin
export GOPATH=$HOME/go/bin
export PATH=$PATH:$GOROOT:$GOPATH

# SIMPLE VERSION
# GOROOT
export PATH=$PATH:/usr/local/go/bin
# PATH
export PATH=$PATH:$HOME/go/bin

```

## Creating gRPC protobuffer

To create gRPC definitions, you

- create proto file with service definitions
- run bash proto command to generate the code

```bash
# get help on commands
protoc --help
# generate greet from greet folder
protoc ./pb/greet.proto --go_out=plugins=grpc:.
# this generates greet.pb.go file
```

## Creating gRPC server

After generating pb file by `protoc` we can initialize gRPC server in go. The bolierplate code is in main.go. Here the basic bits

```go

//default gRPC port on localhost
host := "0.0.0.0:50051"
//listener to tcp port for the host
lis, err := net.Listen("tcp", host)
if err != nil {
log.Fatalf("gRPC server failed: %v", err)
}
// create new grpc server
s := grpc.NewServer()
// register our grpc service and pass grpcServer and out local grpc object
// the Register method is autogenerated by protoc (see readme file)
greetpb.RegisterGreetServiceServer(s, &grpcSrv{})
// start server with greetpb service
err = s.Serve(lis)
if err != nil {
log.Fatalf("Failed to serve greetpb: %v", err)
}

```

The server needs to implement service interface defined in the protobuf generate file. In our first example the service interface is defined in GreetServiceServer.

## Creating gRPC client (consumer)

This client will connect to gRPC server. THe basic boilerplate is in client folder. Basic bits are

```go
// establish connection (without SSL)
cnn, err := grpc.Dial("localhost:50051", grpc.WithInsecure())
if err != nil {
  log.Fatalf("Client could not connect: %v", err)
}
// close at the end
defer cnn.Close()
// register client for greetpb service
c := greetpb.NewGreetServiceClient(cnn)
log.Println("Client registered: ", c)

```

## gRPC Streaming

The stream can be asymetric. The setup on steaming client and server receiver. For exact implementation see calc folder implementation of Average rpc channel.

Sender implementation, see client/main.go

```go
// stream sender
// This will stram numbers to server one by one
func makeAverageRequest(nums []int32) float64 {
  stream, err := calcClient.Average(context.Background())
  if err != nil {
    log.Panicln(err)
  }

  for _, num := range nums {
    msg := calc.AverageRequest{
    Num: num,
    }
    //send a value to a server?!?
    stream.Send(&msg)
  }

  resp, err := stream.CloseAndRecv()
  if err != nil {
    log.Panicln(err)
  }
  return resp.GetMean()
}

```

Stream receiver implementation (in this case serever), see server/main.go

```Go

// Receive a stream of numbers from the client and return average
func (*calcSvc) Average(stream calc.CalcService_AverageServer) error {
  var sum int32 = 0
  var mean float64 = 0
  var cnt int32 = 0

  log.Println("Average channel stram started...")

  for {
    req, err := stream.Recv()
    if err == io.EOF {
    log.Println("Received end of stream")
    mean = float64(sum / cnt)
    return stream.SendAndClose(&calc.AverageResponse{
      Mean: mean,
    })
    }
    if err != nil {
    log.Panicln("Stream error:", err)
    }
    sum += req.GetNum()
    cnt++
  }
}

```
